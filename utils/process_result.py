import re
import json

def parse_proverbs(file_path, start_line, end_line):
    groups = []
    current_group = None
    
    with open(file_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    # Adjust for 0-indexed list
    lines_to_process = lines[max(0, start_line-1):end_line]
    
    for line in lines_to_process:
        line = line.strip()
        if not line:
            continue
            
        # Check for numbered identifier (e.g., "747. ")
        match_num = re.match(r'^(\d+)\.\s+(.*)', line)
        # Check for hyphen variant (e.g., "- ")
        match_hyphen = re.match(r'^-\s+(.*)', line)
        
        if match_num:
            if current_group:
                groups.append(current_group)
            current_group = {
                'id': match_num.group(1),
                'main': match_num.group(2),
                'variants': []
            }
        elif match_hyphen and current_group:
            current_group['variants'].append(match_hyphen.group(1))
            
    if current_group:
        groups.append(current_group)
        
    return groups

manual_map = {
    "784": ["784. 恒産なき者は恒心なし", "784. 浩然の気を養う"],
    "795": ["795. 心の駒に手綱許すな", "795. 小姑一人は鬼千匹にむかう"],
    "801": ["801. 子に過ぎたる宝なし", "801. 命に過ぎたる宝なし"],
    "813": "813. 転んでもただでは起きぬ",
    "848": "848. 鯖の生き腐れ",
    "849": "849. 去り跡へは行くとも死に跡へは行くな",
    "864": "864. 座して食らえば山も空し",
    "874": "874. 親しき仲に礼儀あり",
    "893": "893. 春宵一刻値千金",
    "895": "895. 雌雄を決す",
    "905": "905. 商売は道によって賢し",
    "907": "907. 将を射んとせば先ず馬を射よ",
    "908": ["908. 小を捨てて大に就く", "908. 小異を捨てて大同に就く"],
    "923": "923. 地獄で仏",
    "942": "942. 水火も辞せず",
    "943": "943. 粋が身を食う",
    "946": "946. 好いた水仙好かれた柳",
    "950": "950. 据え膳食わぬは男の恥",
    "961": "961. 精神一到何事か成らざらん",
    "962": "962. 急いては事を仕損じる",
    "970": "970. 背に腹は代えられぬ",
    "980": "980. 先鞭をつける",
    "984": ["984. 千慮の一失", "984. 千慮の一得"],
    "990": "990. 前車の轍を踏む",
    "993": "993. 創業は易く守成は難し",
    "999": "999. 備えあれば憂い無し",
    "1006": "1006. 大敵と見て恐れず小敵と見て侮らず",
    "1009": "1009. 斃れて後已む",
    "1010": "1010. 高きに登るは卑きよりす",
    "1019": "1019. ただより高い物はない",
    "1028": "1028. 足るを知る",
    "1035": "1035. 断じて行えば鬼神も之を避く",
    "1045": "1045. 父の恩は山よりも高く母の恩は海よりも深し",
    "1046": "1046. 父は子の為に隠し子は父のために隠す",
    "1047": "1047. 治に居て乱を忘れず",
    "1052": "1052. 忠言耳に逆らう",
    "1061": "1061. 提灯に釣鐘",
    "1064": "1064. 塵も積もれば山となる",
    "1069": "1069. 月日に関守なし",
    "1075": "1075. 爪に火を点す",
    "1078": "1078. 釣り合わぬは不縁の基",
    "1084": "1084. 貞女は二夫に見えず",
    "1085": "1085. 手が明けば口が明く",
    "1087": "1087. 梃子でも動かぬ",
    "1096": "1096. 天高く馬肥ゆる",
    "1107": "1107. 問うに落ちず語るに落ちる",
    "1113": "1113. 時に遭えば鼠も虎になる",
    "1120": "1120. 隣の白飯より内の粟飯",
    "1122": "1122. 飛ぶ鳥を落とす勢い",
    "1130": "1130. 同病相憐れむ",
    "1132": "1132. 怒髪冠を衝く",
    "1133": "1133. 駑馬十駕",
    "1139": "1139. 無い袖は振れぬ",
    "1140": "1140. 無い時の辛抱ある時の倹約",
    "1141": "1141. 直き木に曲がる枝",
    "1149": "1149. 仲人は宵の口",
    "1157": "1157. 生兵法は大怪我のもと",
    "1161": "1161. 名を捨てて実を取る",
    "1162": "1162. 名を取るより実を取れ",
    "1168": "1168. 苦虫を噛みつぶしたよう",
    "1169": "1169. 握れば拳開けば掌",
    "1180": "1180. 日計足らずして歳計余り有り",
    "1207": ["1207. 盗人の昼寝", "1207. 盗人の寝言"],
    "1235": "1235. 残り物には福がある",
    "1311": "1311. 人酒を飲む、酒酒を飲む、酒人を飲む",
    "1416": "1416. 仏の顔も三度まで",
    "1433": "1433. 人木石に非ず",
    "1465": "1465. 見るは法楽",
    "1467": "1467. 六日の菖蒲十日の菊",
    "1539": "1539. 夕焼けに鎌を研げ",
    "1544": ["1544. 弓折れ矢尽く", "1544. 刀折れ矢尽きる"]
}

if __name__ == "__main__":
    # Process batch 5 (lines 501-1000)
    groups = parse_proverbs('/home/gestnl/flexible-scraping/utils/output.txt', 501, 1000)
    
    with open('/home/gestnl/flexible-scraping/utils/tmp.txt', 'a', encoding='utf-8') as f:
        for g in groups:
            gid = g['id']
            if gid in manual_map:
                val = manual_map[gid]
                if isinstance(val, list):
                    for v in val:
                        f.write(v + '\n')
                else:
                    f.write(val + '\n')
            else:
                f.write(f"{gid}. {g['main']}\n")
